var db = require('controllers/database');
var mongoose = require('mongoose');
var taxes = mongoose.model('taxes');
var drivers = mongoose.model('drivers');
var method	= require('../../route/methods');

exports.getTaxi = function(serial,callback){
  taxes.find({serial:serial},function(err,data){
		if(data.length != 0){
      var keyVitual = method.keyVirtual();
      var key = method.key(keyVitual);
      var idTaxi = data[0]._id;
      var mark = method.encode(data[0].mark,key);
      var model = method.encode(data[0].model,key);
      var serial = method.encode(data[0].serial,key);
      var places = method.encode((data[0].places).toString(),key);
      var luggages = method.encode((data[0].luggages).toString(),key);
      var color = method.encode(data[0].color,key);
      callback({'res':true,'key':keyVitual,'_id':idTaxi,'mark':mark,'model':model,'serial':serial,'places':places,
      'luggages':luggages,'color':color});
    }else{
      callback({'res':false});
    }
  });
}

exports.addTaxiToDriver = function(token,idTaxi,callback){
  taxes.find({_id:idTaxi},function(err,data){
		if(data.length != 0){
      var datenew = new Date();
      var date = datenew.getDate() + "/"
        + (datenew.getMonth()+1)  + "/"
        + datenew.getFullYear() + " "
        + datenew.getHours() + ":"
        + datenew.getMinutes() + ":"
        + datenew.getSeconds();
      var model = data[0].model;
      var serial = data[0].serial;
      var places = data[0].places;
      var luggages = data[0].luggages;
      var color = data[0].color;
      drivers.update({_id:token,'taxis.working':true},{$set:{'taxis.working':false},$push:{taxis:{idTaxi:idTaxi,model:model,serial:serial,places:places,luggages:luggages,color:color,date:date,working:true}}},{multi:true},function(err){
        if(err){
          callback({'res':false});
        }else{
          callback({'res':true});
        }
      });
    }else{
      callback({'res':false});
    }
  });
}
